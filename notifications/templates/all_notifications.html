{% extends 'base.html' %}
{% block title %}All Notifications{% endblock %}

{% block content %}
<div class="container py-5">
  <h2 class="mb-4 text-center">All Notifications</h2>

  {% if notifications %}
    <ul class="list-group shadow-sm">
      {% for notif in notifications %}
        <li class="list-group-item d-flex justify-content-between align-items-start {% if not notif.is_read %}bg-light{% endif %}"
            data-id="{{ notif.id }}">
          <div>
            <div class="fw-semibold notification-message mb-2">{{ notif.message|safe }}</div>
            <small class="text-muted">
              {% if notif.sender %}
                FROM {{ notif.sender.first_name }}
              {% else %}
                System
              {% endif %}
              â€¢ {{ notif.created_at|date:"Y-m-d H:i" }}
            </small>
          </div>

          {% if not notif.is_read %}
            <button class="btn btn-sm btn-outline-primary mark-read-btn">Mark as Read</button>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-center text-muted mt-4">No notifications found.</p>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  document.querySelectorAll('.mark-read-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const li = btn.closest('li');
      const notifId = li.dataset.id;
      fetch(`/notifications/${notifId}/read/`, {
        method: 'PATCH',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        }
      }).then(res => {
        if (res.ok) {
          li.classList.remove('bg-light');
          btn.remove();
        }
      });
    });
  });
});
</script>
{% endblock %}
