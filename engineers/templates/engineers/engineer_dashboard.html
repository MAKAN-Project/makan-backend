{% extends "base.html" %}
{% load static %}

{% block title %}Engineer Dashboard{% endblock %}

{% block content %}
<style>
  .notification-message a {
  color: #0d6efd;
  text-decoration: none;
  font-weight: 500;
  word-break: break-all;
}

.notification-message a:hover {
  text-decoration: underline;
}

</style>
<div class="container-fluid mt-5 pt-4">
  <div class="row">

    <!-- Sidebar -->
    <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar vh-100 border-end position-fixed">
      <div class="pt-3 px-2">
        <h5 class="text-muted mb-4">Engineer Dashboard</h5>
        <ul class="nav flex-column">
          <li class="nav-item mb-1">
            <a class="nav-link active rounded" href="{% url 'engineers_dashboard' %}">
              <i class="bi bi-speedometer2 me-1"></i> Dashboard
            </a>
          </li>
          <li class="nav-item mb-1"><a class="nav-link" href="#"><i class="bi bi-card-checklist me-1"></i> Requests</a></li>
          <li class="nav-item mb-1"><a class="nav-link" href="#"><i class="bi bi-calendar-event me-1"></i> Sessions</a></li>
          <li class="nav-item mb-1"><a class="nav-link" href="#"><i class="bi bi-folder2-open me-1"></i> Portfolio</a></li>
          <li class="nav-item mb-1"><a class="nav-link" href="#"><i class="bi bi-lightbulb me-1"></i> AI Preview</a></li>
          <li class="nav-item mb-1"><a class="nav-link" href="#"><i class="bi bi-box-seam me-1"></i> 3D Models</a></li>
          <li class="nav-item mb-1"><a class="nav-link" href="#"><i class="bi bi-person-circle me-1"></i> Profile</a></li>
        </ul>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 offset-md-3">

      <!-- Dashboard Cards -->
      <div class="row my-4">
        <div class="col-md-6 mb-3">
          <div class="card text-center shadow-sm rounded-3">
            <div class="card-body">
              <i class="bi bi-card-checklist fs-1 text-warning mb-2"></i>
              <h5 class="card-title fw-bold">Active Project Requests</h5>
              <p class="display-6">{{ active_project_requests_count }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-6 mb-3">
          <div class="card text-center shadow-sm rounded-3">
            <div class="card-body">
              <i class="bi bi-check2-circle fs-1 text-success mb-2"></i>
              <h5 class="card-title fw-bold">Completed Projects</h5>
              <p class="display-6">{{ completed_projects_count }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Active Project Requests -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header">
          <h5>Active Project Requests</h5>
        </div>
        <div class="card-body table-responsive">
   <table class="table table-hover align-middle">
    <thead class="table-light">
        <tr>
            <th>Client</th>
            <th>Description</th>
            <th>Status</th>
            <th>File</th>
            <th>Created At</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for req in active_project_requests %}
        <tr>
            <td>{{ req.client.first_name }} {{ req.client.last_name }}</td>
            <td>{{ req.description }}</td>
            <td>
                {% if req.status == "pending" %}
                    <span class="badge bg-info text-dark">Pending</span>
                {% elif req.status == "in_progress" %}
                    <span class="badge bg-warning text-dark">In Progress</span>
                {% elif req.status == "rejected" %}
                    <span class="badge bg-danger text-white">Rejected</span>
                {% endif %}
            </td>
            <td>
                {% if req.files.all|length %}
                    {% for file in req.files.all %}
                        <a href="{{ file.file.url }}" target="_blank">{{ file.file_name }}</a>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                {% else %}
                    N/A
                {% endif %}
            </td>
            <td>{{ req.created_at|date:"Y-m-d H:i" }}</td>
            <td>
                {% if req.status == "pending" %}
                    <!-- زر فتح المودال للقبول -->
                    <button type="button"
                            class="btn btn-success btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#scheduleModal{{ req.request_id }}">
                        Accept
                    </button>

                    <form method="POST" action="{% url 'reject_project_request' req.request_id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm">Reject</button>
                    </form>

                    <!-- Modal لجدولة الجلسة -->
                    <div class="modal fade" id="scheduleModal{{ req.request_id }}" tabindex="-1" aria-labelledby="scheduleModalLabel{{ req.request_id }}" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <form method="POST" action="{% url 'accept_project_request' req.request_id %}">
                                    {% csrf_token %}
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="scheduleModalLabel{{ req.request_id }}">Schedule Session</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <label for="scheduled_at{{ req.request_id }}" class="form-label">Select date and time</label>
                                        {% if req.selected_availability %}
                                            <input type="datetime-local"
                                                   class="form-control"
                                                   name="scheduled_at"
                                                   id="scheduled_at{{ req.request_id }}"
                                                   value="{{ req.selected_availability.date|date:'Y-m-d' }}T{{ req.selected_availability.start_time|time:'H:i' }}"
                                                   required>
                                        {% else %}
                                            <input type="datetime-local"
                                                   class="form-control"
                                                   name="scheduled_at"
                                                   id="scheduled_at{{ req.request_id }}"
                                                   required>
                                        {% endif %}
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-primary">Confirm</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                {% elif req.status == "in_progress" %}
                    <!-- زر فتح المودال لرفع الملف للمشاريع "in_progress" فقط -->
                    <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#uploadFileModal{{ req.request_id }}">
                        Upload File
                    </button>

                    <!-- Modal لرفع الملف -->
                    <div class="modal fade" id="uploadFileModal{{ req.request_id }}" tabindex="-1" aria-labelledby="uploadFileModalLabel{{ req.request_id }}" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form method="POST" action="{% url 'upload_project_file' req.request_id %}" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="uploadFileModalLabel{{ req.request_id }}">Upload File</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label for="file_name{{ req.request_id }}" class="form-label">File Name</label>
                                            <input type="text" class="form-control" id="file_name{{ req.request_id }}" name="file_name" placeholder="Enter file name" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="file_upload{{ req.request_id }}" class="form-label">Choose File</label>
                                            <input type="file" class="form-control" id="file_upload{{ req.request_id }}" name="file" required>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-primary">Upload</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <span class="text-muted">No actions</span>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center text-muted">No active project requests</td>
        </tr>
        {% endfor %}
    </tbody>
</table>


        </div>
      </div>
<!-- Scheduled Sessions -->
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-primary bg-opacity-10">
    <h5>Today's Sessions</h5>
  </div>
  <div class="card-body table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Client</th>
          <th>Time</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for session in sessions %}
        <tr>
          <td>{{ session.user.first_name }} {{ session.user.last_name }}</td>
          <td>{{ session.scheduled_at|date:"Y-m-d H:i" }}</td>
          <td>
            {% if session.status == "scheduled" %}
              <span class="badge bg-info text-dark">Scheduled</span>
            {% elif session.status == "in_progress" %}
              <span class="badge bg-warning text-dark">In Progress</span>
            {% elif session.status == "completed" %}
              <span class="badge bg-success">Completed</span>
            {% endif %}
          </td>
          <td>
            {% if session.meeting_link %}
              <a href="{{ session.host_link }}" target="_blank" class="btn btn-primary btn-sm">
                🎥 Start Meeting
              </a>
              <a href="{{ session.meeting_link }}" target="_blank" class="btn btn-outline-success btn-sm">
                👥 Join
              </a>
            {% else %}
              <form method="POST" action="{% url 'create_zoom_meeting' session.session_id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-primary">Create Meeting</button>
              </form>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="text-center text-muted">No sessions scheduled today</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

      <!-- Reschedule Requests -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning bg-opacity-10">
          <h5>Reschedule Requests</h5>
        </div>
        <div class="card-body table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Client</th>
                <th>Old Time</th>
                <th>New Requested Time</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for session in sessions %}
                {% if session.status == "reschedule_pending" %}
                <tr>
                  <td>{{ session.user.first_name }} {{ session.user.last_name }}</td>
                  <td>{{ session.old_scheduled_at|date:"Y-m-d H:i" }}</td>
                  <td><span class="text-primary fw-bold">{{ session.scheduled_at|date:"Y-m-d H:i" }}</span></td>
                  <td><span class="badge bg-warning text-dark">Pending Approval</span></td>
                  <td>
                    <form method="POST" action="{% url 'approve_reschedule' session.id %}" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-success btn-sm">✔ Approve</button>
                    </form>
                    <form method="POST" action="{% url 'reject_reschedule' session.id %}" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-danger btn-sm">✖ Reject</button>
                    </form>
                  </td>
                </tr>
                {% endif %}
              {% empty %}
              <tr><td colspan="5" class="text-center text-muted">No reschedule requests</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Quick Actions -->
     <!-- Quick Actions -->
<div class="card mb-4 shadow-sm">
  <div class="card-header">
    <h5>Quick Actions</h5>
  </div>
  <div class="card-body d-flex flex-wrap gap-2">
    <a href="{% url 'manage_availability' %}" class="btn btn-primary">
  <i class="bi bi-calendar-plus"></i> Set Availability
</a>
    <a href="#" class="btn btn-success"><i class="bi bi-upload"></i> Upload Design</a>
    <a href="#" class="btn btn-warning"><i class="bi bi-lightbulb"></i> AI Preview</a>
    <a href="#" class="btn btn-info"><i class="bi bi-box-seam"></i> 3D Models</a>
  </div>
</div>


    </main>
  </div>
</div>
{% endblock %}
