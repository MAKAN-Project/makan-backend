{% extends "base.html" %}

{% block title %}Engineer Dashboard{% endblock %}

{% block content %}
<style>
/* Sidebar */
.sidebar,
.sidebar * {
  color: #111 !important;
  text-shadow: none !important;
  opacity: 1 !important;
}
.sidebar .nav-link {
  font-weight: 600;
  color: #111 !important;
}
.sidebar .nav-link:hover {
  background-color: rgba(0, 123, 255, 0.1) !important;
  color: #007bff !important;
}
.sidebar .nav-link.active {
  background-color: #007bff !important;
  color: #fff !important;
}
.sidebar h5,
.sidebar .nav-link i {
  color: #007bff !important;
}
body {
  -webkit-font-smoothing: auto !important;
  -moz-osx-font-smoothing: auto !important;
}

/* Cards */
.card .card-body i {
  font-size: 2.5rem;
}

/* Tables */
.table .badge {
  font-weight: 600;
}
</style>

<div class="container-fluid">
  <div class="row">

    <!-- Sidebar -->
    <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar vh-100 border-end position-fixed">
      <div class="pt-3 px-2">
        <h5 class="text-muted mb-4">Engineer Dashboard</h5>
        <ul class="nav flex-column">
          <li class="nav-item mb-1">
            <a class="nav-link active rounded" href="{% url 'engineers_dashboard' %}">
              <i class="bi bi-speedometer2 me-1"></i> Dashboard
            </a>
          </li>
          <li class="nav-item mb-1"><a class="nav-link" href="#"><i class="bi bi-card-checklist me-1"></i> Requests</a></li>
          <li class="nav-item mb-1"><a class="nav-link" href="#"><i class="bi bi-calendar-event me-1"></i> Sessions</a></li>
          <li class="nav-item mb-1"><a class="nav-link" href="#"><i class="bi bi-folder2-open me-1"></i> Files / Portfolio</a></li>
          <li class="nav-item mb-1"><a class="nav-link" href="#"><i class="bi bi-lightbulb me-1"></i> AI Preview</a></li>
          <li class="nav-item mb-1"><a class="nav-link" href="#"><i class="bi bi-box-seam me-1"></i> 3D Models</a></li>
          <li class="nav-item mb-1"><a class="nav-link" href="#"><i class="bi bi-person-circle me-1"></i> Profile</a></li>
        </ul>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 offset-md-3">

      <!-- Dashboard Cards -->
      <div class="row my-4">
        <div class="col-md-6 mb-3">
          <div class="card text-center shadow-sm rounded-3">
            <div class="card-body">
              <i class="bi bi-card-checklist fs-1 text-warning mb-2"></i>
              <h5 class="card-title fw-bold">Active Project Requests</h5>
              <p class="display-6">{{ active_project_requests_count }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-6 mb-3">
          <div class="card text-center shadow-sm rounded-3">
            <div class="card-body">
              <i class="bi bi-check2-circle fs-1 text-success mb-2"></i>
              <h5 class="card-title fw-bold">Completed Projects</h5>
              <p class="display-6">{{ completed_projects_count }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Active Project Requests -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header">
          <h5>Active Project Requests</h5>
        </div>
        <div class="card-body table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Client</th>
                <th>Description</th>
                <th>Status</th>
                <th>File</th>
                <th>Created At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for req in active_project_requests %}
  <tr>
    <td>{{ req.client.first_name }} {{ req.client.last_name }}</td>
    <td>{{ req.description }}</td>
    <td>
      {% if req.status == "pending" %}
        <span class="badge bg-info text-dark">Pending</span>
      {% elif req.status == "in_progress" %}
        <span class="badge bg-warning text-dark">In Progress</span>
      {% elif req.status == "rejected" %}
        <span class="badge bg-danger text-white">Rejected</span>
      {% endif %}
    </td>
    <td>
      {% if req.file %}
        <a href="{{ req.file.file.url }}" target="_blank">{{ req.file.file_name }}</a>
      {% else %}
        N/A
      {% endif %}
    </td>
    <td>{{ req.created_at|date:"Y-m-d H:i" }}</td>
    <td>
      {% if req.status == "pending" %}
        <form method="POST" action="{% url 'accept_project_request' req.request_id %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-success btn-sm">Accept</button>
        </form>
        <form method="POST" action="{% url 'reject_project_request' req.request_id %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger btn-sm">Reject</button>
        </form>
      {% else %}
        <span class="text-muted">No actions</span>
      {% endif %}
    </td>
  </tr>
{% empty %}
  <tr>
    <td colspan="6" class="text-center text-muted">No active project requests</td>
  </tr>
{% endfor %}

            </tbody>
          </table>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header">
          <h5>Quick Actions</h5>
        </div>
        <div class="card-body d-flex flex-wrap gap-2">
          <a href="#" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Create Session</a>
          <a href="#" class="btn btn-success"><i class="bi bi-upload"></i> Upload Design</a>
          <a href="#" class="btn btn-warning"><i class="bi bi-lightbulb"></i> AI Preview</a>
          <a href="#" class="btn btn-info"><i class="bi bi-box-seam"></i> 3D Models</a>
        </div>
      </div>

    </main>
  </div>
</div>
<!-- قائمة Project Requests -->
<ul class="list-group">
  {% for request in active_project_requests %}
  <li class="list-group-item d-flex justify-content-between align-items-center">
    {{ request.client.first_name }} {{ request.client.last_name }} - {{ request.description }}
    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#requestModal{{ request.request_id }}">
      View
    </button>
  </li>

  <!-- Modal -->
  <div class="modal fade" id="requestModal{{ request.request_id }}" tabindex="-1" aria-labelledby="requestModalLabel{{ request.request_id }}" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="requestModalLabel{{ request.request_id }}">Project Request Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>Client:</strong> {{ request.client.first_name }} {{ request.client.last_name }}</p>
          <p><strong>Description:</strong> {{ request.description }}</p>
          <p><strong>Status:</strong> {{ request.status }}</p>
          {% if request.file_set.all %}
            <p><strong>Files:</strong></p>
            <ul>
              {% for file in request.file_set.all %}
                <li><a href="{{ file.file.url }}" target="_blank">{{ file.filename }}</a></li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
        <div class="modal-footer">
          <form method="POST" action="{% url 'accept_project_request' request.request_id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-success">Accept</button>
          </form>
          <form method="POST" action="{% url 'reject_project_request' request.request_id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Reject</button>
          </form>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</ul>

{% endblock %}
